<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ë° ë ˆí¬íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* ë¼ì´íŠ¸í•œ ë°°ê²½ */
        }
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ê¹”ë”í•œ UIë¥¼ ìœ„í•´) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden">
    <!-- ì‚¬ì´ë“œë°” (ë¡œê³  ë° ë„¤ë¹„ê²Œì´ì…˜) -->
    <aside class="w-64 bg-white shadow-xl flex flex-col p-4 border-r border-gray-200">
        
        <!-- ë¡œê³  ì˜ì—­ -->
        <div class="p-4 mb-6 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <!-- íœ´í«ë„¤ì´ì³ì½”ë¦¬ì•„ ë¡œê³  ì´ë¯¸ì§€ë¡œ ëŒ€ì²´ -->
                <img src="íœ´í«ë„¤ì´ì³ì½”ë¦¬ì•„ ë¡œê³ .png" alt="íœ´í«ë„¤ì´ì³ì½”ë¦¬ì•„ ë¡œê³ " class="h-10 w-10 object-contain">
                <h1 class="text-xl font-extrabold text-gray-800 tracking-tight">íœ´í« ê´€ë¦¬</h1>
            </div>
            <p class="text-xs text-gray-500 mt-2">v1.0. ì‚¬ìš©ì ID: <span id="user-id" class="font-mono text-xs text-indigo-600">Loading...</span></p>
            <p class="text-[10px] text-red-500 mt-2">ê³µìœ  ëª¨ë“œ í™œì„±í™”ë¨ (Public Data Path)</p>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ íƒ­ -->
        <nav class="flex flex-col space-y-2">
            <button data-tab="register" class="tab-button w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors duration-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">
                ğŸ‘¤ íšŒì› ë“±ë¡
            </button>
            <button data-tab="report-form" class="tab-button w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors duration-200 text-gray-700 hover:bg-gray-100">
                ğŸ“ ë ˆí¬íŠ¸ ì‘ì„±
            </button>
            <button data-tab="my-reports" class="tab-button w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors duration-200 text-gray-700 hover:bg-gray-100">
                ğŸ“‚ ë‚˜ì˜ ë ˆí¬íŠ¸ (ì „ì²´ ê³µìœ )
            </button>
        </nav>

        <div id="status-message" class="mt-auto p-4 text-xs text-center text-red-500 hidden"></div>
    </aside>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <main class="flex-1 p-8 overflow-y-auto hide-scrollbar">
        <h2 id="main-title" class="text-3xl font-bold text-gray-900 mb-8">íšŒì› ë“±ë¡</h2>

        <!-- íƒ­ ì»¨í…ì¸  -->
        <div id="tab-content">
            <!-- íšŒì› ë“±ë¡ í¼ -->
            <div id="register-tab" class="tab-pane">
                <form id="member-registration-form" class="bg-white p-6 rounded-xl shadow-lg max-w-lg">
                    <div class="space-y-4">
                        <label class="block">
                            <span class="text-gray-700 font-medium">ì´ë¦„ (Name)</span>
                            <input type="text" id="member-name" required placeholder="í™ê¸¸ë™" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">ì§í•¨ (Title)</span>
                            <input type="text" id="member-title" required placeholder="íŒ€ì¥" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">ì—°ë½ì²˜ (Contact)</span>
                            <input type="tel" id="member-contact" required placeholder="010-1234-5678" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 font-medium">ì´ë©”ì¼ (Email)</span>
                            <input type="email" id="member-email" required placeholder="user@huppet.co.kr" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </label>
                    </div>
                    <button type="submit" class="mt-6 w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        íšŒì› ë“±ë¡
                    </button>
                </form>
            </div>

            <!-- ë ˆí¬íŠ¸ ì‘ì„± í¼ -->
            <div id="report-form-tab" class="tab-pane hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">1. ë ˆí¬íŠ¸ ì‘ì„±ì ì„ íƒ (ê³µìœ  íšŒì› ëª©ë¡)</h3>
                    <div id="member-select-list" class="flex flex-wrap gap-3 p-4 border rounded-lg bg-gray-50 min-h-[5rem]">
                        <!-- íšŒì› ì´ë¦„ íƒ­/ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                        <p id="member-select-placeholder" class="text-gray-500">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤. 'íšŒì› ë“±ë¡' íƒ­ì—ì„œ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.</p>
                    </div>

                    <form id="report-submission-form" class="mt-8 pt-4 border-t" style="pointer-events: none; opacity: 0.5;">
                        <input type="hidden" id="selected-member-id">
                        <p class="mb-4 text-lg font-semibold text-gray-700">2. ë ˆí¬íŠ¸ ë‚´ìš© ì‘ì„± (ì„ íƒëœ íšŒì›: <span id="selected-member-name" class="text-indigo-600 font-bold">ì—†ìŒ</span>)</p>

                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">ë ˆí¬íŠ¸ ì œëª©</span>
                            <input type="text" id="report-title" required placeholder="2024ë…„ 4ë¶„ê¸° ì‹¤ì  ë ˆí¬íŠ¸" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </label>

                        <label class="block">
                            <span class="text-gray-700 font-medium">ë ˆí¬íŠ¸ ë‚´ìš©</span>
                            <textarea id="report-content" required rows="8" placeholder="ì£¼ìš” ì„±ê³¼ ë° ë‹¤ìŒ ë¶„ê¸° ê³„íšì„ ìƒì„¸íˆ ì‘ì„±í•˜ì„¸ìš”." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border"></textarea>
                        </label>
                        
                        <button type="submit" class="mt-6 w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            ë ˆí¬íŠ¸ ì €ì¥
                        </button>
                    </form>
                </div>
            </div>

            <!-- ë‚˜ì˜ ë ˆí¬íŠ¸ ëª©ë¡ -->
            <div id="my-reports-tab" class="tab-pane hidden">
                <div id="reports-list" class="space-y-4">
                    <!-- ë ˆí¬íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
                    <p id="reports-placeholder" class="text-gray-500 p-4 border rounded-lg bg-white shadow-sm">ì•„ì§ ì‘ì„±ëœ ë ˆí¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (ì—ëŸ¬ ë° ì„±ê³µ ë©”ì‹œì§€) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">ì•Œë¦¼</h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <button id="modal-close-button" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">í™•ì¸</button>
            </div>
        </div>
    </main>
</div>

<!-- Firebase ë° ì•± ë¡œì§ ìŠ¤í¬ë¦½íŠ¸ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
    setLogLevel('Debug');

    // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    let db, auth, userId = null;
    let members = [];
    let reports = [];
    let activeTab = 'register';
    let selectedMemberId = null;

    // Canvas í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // DOM ìš”ì†Œ ìºì‹±
    const tabContent = document.getElementById('tab-content');
    const tabButtons = document.querySelectorAll('.tab-button');
    const mainTitle = document.getElementById('main-title');
    const userIdDisplay = document.getElementById('user-id');
    const memberRegistrationForm = document.getElementById('member-registration-form');
    const memberSelectList = document.getElementById('member-select-list');
    const memberSelectPlaceholder = document.getElementById('member-select-placeholder');
    const reportSubmissionForm = document.getElementById('report-submission-form');
    const reportsList = document.getElementById('reports-list');
    const reportsPlaceholder = document.getElementById('reports-placeholder');
    const selectedMemberNameDisplay = document.getElementById('selected-member-name');
    const modal = document.getElementById('custom-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalCloseButton = document.getElementById('modal-close-button');


    // ======= Firebase ì´ˆê¸°í™” ë° ì¸ì¦ =======
    async function initializeFirebase() {
        if (!firebaseConfig) {
            showError("Firebase ì„¤ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•±ì´ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // ì¸ì¦ ìƒíƒœ ë³€í™” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ì‹œì‘
                    setupFirestoreListeners();
                    console.log("ì¸ì¦ ì™„ë£Œ. User ID:", userId);
                } else {
                    console.log("ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒë˜ì—ˆê±°ë‚˜ ì¸ì¦ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    // ìµëª… ë¡œê·¸ì¸ ì‹œë„ (ë˜ëŠ” ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸)
                    handleAuth(auth);
                }
            });

            // ì´ˆê¸° ì¸ì¦ ì‹œë„
            if (!auth.currentUser) {
                await handleAuth(auth);
            }

        } catch (error) {
            console.error("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            showError("ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜: " + error.message);
        }
    }

    async function handleAuth(authInstance) {
        try {
            if (initialAuthToken) {
                await signInWithCustomToken(authInstance, initialAuthToken);
                console.log("Custom tokenìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ.");
            } else {
                await signInAnonymously(authInstance);
                console.log("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ.");
            }
        } catch (error) {
            console.error("Firebase ì¸ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            showError("ì¸ì¦ ì˜¤ë¥˜: " + error.message);
        }
    }

    // ======= Firestore ë°ì´í„° ê²½ë¡œ ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì • =======

    // ì§ì› ê³µìœ ë¥¼ ìœ„í•´ Public Data Path ì‚¬ìš©
    function getPublicCollectionPath(collectionName) {
        // ëª¨ë“  ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ê³µìœ í•  ìˆ˜ ìˆëŠ” ê³µìš© ê²½ë¡œ
        return `/artifacts/${appId}/public/data/${collectionName}`;
    }

    function setupFirestoreListeners() {
        if (!db || !userId) return;

        // 1. íšŒì› ëª©ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ê³µìœ )
        const membersRef = collection(db, getPublicCollectionPath('members'));
        onSnapshot(membersRef, (snapshot) => {
            members = [];
            snapshot.forEach(doc => {
                members.push({ id: doc.id, ...doc.data() });
            });
            console.log("íšŒì› ëª©ë¡ ì—…ë°ì´íŠ¸ (ê³µìœ ):", members.length, "ëª…");
            renderMemberSelectList();
            // í˜„ì¬ ì„ íƒëœ íšŒì›ì´ ëª©ë¡ì— ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸
            if (selectedMemberId && !members.find(m => m.id === selectedMemberId)) {
                selectedMemberId = null;
                updateReportFormState();
            }
        }, (error) => {
            console.error("íšŒì› ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            showError("íšŒì› ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜.");
        });

        // 2. ë ˆí¬íŠ¸ ëª©ë¡ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ê³µìœ )
        const reportsRef = collection(db, getPublicCollectionPath('reports'));
        onSnapshot(reportsRef, (snapshot) => {
            reports = [];
            snapshot.forEach(doc => {
                reports.push({ id: doc.id, ...doc.data() });
            });
            // ìµœì‹  ë ˆí¬íŠ¸ê°€ ìœ„ì— ì˜¤ë„ë¡ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
            reports.sort((a, b) => {
                // createdAt í•„ë“œê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ ì¥ì¹˜
                const dateA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                const dateB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                return dateB - dateA;
            });
            console.log("ë ˆí¬íŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸ (ê³µìœ ):", reports.length, "ê°œ");
            renderReportsList();
        }, (error) => {
            console.error("ë ˆí¬íŠ¸ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            showError("ë ˆí¬íŠ¸ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜.");
        });
    }


    // ======= UI ë° íƒ­ ê´€ë¦¬ í•¨ìˆ˜ (ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ë³€ê²½ ì—†ìŒ) =======

    function switchTab(tabId) {
        activeTab = tabId;
        
        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        tabButtons.forEach(btn => {
            const isSelected = btn.dataset.tab === tabId;
            btn.classList.toggle('bg-indigo-50', isSelected);
            btn.classList.toggle('text-indigo-700', isSelected);
            btn.classList.toggle('hover:bg-indigo-100', isSelected);
            btn.classList.toggle('text-gray-700', !isSelected);
            btn.classList.toggle('hover:bg-gray-100', !isSelected);
        });

        // ì»¨í…ì¸  íŒ¨ë„ ì „í™˜
        tabContent.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.add('hidden');
        });
        document.getElementById(`${tabId}-tab`).classList.remove('hidden');

        // ë©”ì¸ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        const titles = {
            'register': 'íšŒì› ë“±ë¡',
            'report-form': 'ë ˆí¬íŠ¸ ì‘ì„±',
            'my-reports': 'ë‚˜ì˜ ë ˆí¬íŠ¸ (ì „ì²´ ê³µìœ )'
        };
        mainTitle.textContent = titles[tabId] || 'ì‹œìŠ¤í…œ ê´€ë¦¬';

        // ë ˆí¬íŠ¸ í¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë ˆí¬íŠ¸ í¼ íƒ­ì¼ ë•Œë§Œ)
        if (tabId === 'report-form') {
            updateReportFormState();
        }
    }

    // íšŒì› ì„ íƒ ë²„íŠ¼ (íƒ­ì²˜ëŸ¼) ë Œë”ë§
    function renderMemberSelectList() {
        memberSelectList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        memberSelectPlaceholder.classList.add('hidden');

        if (members.length === 0) {
            memberSelectPlaceholder.classList.remove('hidden');
            selectedMemberId = null;
            updateReportFormState();
            return;
        }

        members.forEach(member => {
            const isSelected = member.id === selectedMemberId;
            const button = document.createElement('button');
            button.textContent = member.name;
            button.dataset.memberId = member.id;
            button.className = `px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 shadow-sm
                                ${isSelected 
                                    ? 'bg-indigo-600 text-white shadow-indigo-300' 
                                    : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-300'}`;
            
            button.addEventListener('click', () => {
                selectedMemberId = member.id;
                renderMemberSelectList(); // UI ì—…ë°ì´íŠ¸
                updateReportFormState(); // í¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            });
            memberSelectList.appendChild(button);
        });

        updateReportFormState();
    }

    // ë ˆí¬íŠ¸ í¼ì˜ ìƒíƒœ (ì‘ì„± ê°€ëŠ¥ ì—¬ë¶€ ë° ì„ íƒëœ ì´ë¦„) ì—…ë°ì´íŠ¸
    function updateReportFormState() {
        const selectedMember = members.find(m => m.id === selectedMemberId);

        if (selectedMember) {
            selectedMemberNameDisplay.textContent = selectedMember.name;
            reportSubmissionForm.style.pointerEvents = 'auto';
            reportSubmissionForm.style.opacity = '1';
        } else {
            selectedMemberNameDisplay.textContent = 'ì—†ìŒ';
            reportSubmissionForm.style.pointerEvents = 'none';
            reportSubmissionForm.style.opacity = '0.5';
        }
    }

    // ë‚˜ì˜ ë ˆí¬íŠ¸ ëª©ë¡ ë Œë”ë§
    function renderReportsList() {
        reportsList.innerHTML = '';
        reportsPlaceholder.classList.add('hidden');

        if (reports.length === 0) {
            reportsPlaceholder.classList.remove('hidden');
            reportsList.appendChild(reportsPlaceholder);
            return;
        }

        reports.forEach(report => {
            const member = members.find(m => m.id === report.memberId);
            const memberName = member ? member.name : 'ì•Œ ìˆ˜ ì—†ëŠ” íšŒì›';
            const timestamp = report.createdAt ? report.createdAt.toDate().toLocaleString('ko-KR') : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

            const reportCard = document.createElement('div');
            reportCard.className = 'bg-white p-5 rounded-lg shadow-md border border-gray-100 hover:shadow-lg transition-shadow duration-200';
            reportCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-mono px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full">${memberName}</span>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <h4 class="text-xl font-bold text-gray-800 mb-1">${report.title}</h4>
                <p class="text-sm text-gray-600 truncate">${report.content.split('\n')[0]}</p>
                <button data-report-id="${report.id}" class="view-report-btn mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-medium">ìì„¸íˆ ë³´ê¸°</button>
            `;
            reportsList.appendChild(reportCard);
        });

        // 'ìì„¸íˆ ë³´ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        reportsList.querySelectorAll('.view-report-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const reportId = e.target.dataset.reportId;
                const report = reports.find(r => r.id === reportId);
                if (report) {
                    const member = members.find(m => m.id === report.memberId);
                    const memberName = member ? member.name : 'ì•Œ ìˆ˜ ì—†ëŠ” íšŒì›';
                    showModal(
                        `ë ˆí¬íŠ¸ ìƒì„¸: ${report.title}`, 
                        `ì‘ì„±ì: ${memberName} (ID: ${report.memberId})\n\nì œëª©: ${report.title}\n\në‚´ìš©:\n${report.content}`
                    );
                }
            });
        });
    }


    // ======= ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ =======

    // íšŒì› ë“±ë¡ ì²˜ë¦¬
    memberRegistrationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const memberData = {
            name: document.getElementById('member-name').value.trim(),
            title: document.getElementById('member-title').value.trim(),
            contact: document.getElementById('member-contact').value.trim(),
            email: document.getElementById('member-email').value.trim(),
            createdAt: serverTimestamp()
        };

        if (!db || !userId) {
            showError("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            // Public Collection ì‚¬ìš©
            const membersRef = collection(db, getPublicCollectionPath('members'));
            await addDoc(membersRef, memberData);
            memberRegistrationForm.reset();
            showModal("ì„±ê³µ", `íšŒì› '${memberData.name}' ë‹˜ì˜ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (ì§ì›ë“¤ê³¼ ê³µìœ ë©ë‹ˆë‹¤)`);
            // ë ˆí¬íŠ¸ ì‘ì„± íƒ­ìœ¼ë¡œ ìë™ ì´ë™
            switchTab('report-form'); 
        } catch (error) {
            console.error("íšŒì› ë“±ë¡ ì‹¤íŒ¨:", error);
            showError("íšŒì› ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
    });

    // ë ˆí¬íŠ¸ ì €ì¥ ì²˜ë¦¬
    reportSubmissionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!selectedMemberId) {
            showModal("ê²½ê³ ", "ë ˆí¬íŠ¸ë¥¼ ì‘ì„±í•  íšŒì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const reportData = {
            memberId: selectedMemberId, // ë ˆí¬íŠ¸ ì‘ì„±ì ID (íšŒì› ID)
            authorId: userId, // ë ˆí¬íŠ¸ë¥¼ ì‹¤ì œë¡œ ì €ì¥í•œ ì§ì›(í˜„ì¬ ì‚¬ìš©ì) ID
            title: document.getElementById('report-title').value.trim(),
            content: document.getElementById('report-content').value.trim(),
            createdAt: serverTimestamp()
        };

        if (!db || !userId) {
            showError("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            // Public Collection ì‚¬ìš©
            const reportsRef = collection(db, getPublicCollectionPath('reports'));
            await addDoc(reportsRef, reportData);
            reportSubmissionForm.reset();
            // ì„ íƒëœ íšŒì› ì´ë¦„ì€ ìœ ì§€
            document.getElementById('report-title').value = '';
            document.getElementById('report-content').value = '';

            showModal("ì„±ê³µ", `ë ˆí¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì§ì›ë“¤ê³¼ ê³µìœ ë©ë‹ˆë‹¤)`);
            // ë‚˜ì˜ ë ˆí¬íŠ¸ íƒ­ìœ¼ë¡œ ìë™ ì´ë™
            switchTab('my-reports'); 
        } catch (error) {
            console.error("ë ˆí¬íŠ¸ ì €ì¥ ì‹¤íŒ¨:", error);
            showError("ë ˆí¬íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
        }
    });

    // íƒ­ ë²„íŠ¼ í´ë¦­ ë¦¬ìŠ¤ë„ˆ
    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            switchTab(e.currentTarget.dataset.tab);
        });
    });

    // ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜
    function showModal(title, message) {
        modalTitle.textContent = title;
        // ë©”ì‹œì§€ì— ì¤„ë°”ê¿ˆ ë¬¸ì ì²˜ë¦¬
        modalMessage.innerHTML = message.replace(/\n/g, '<br>'); 
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    modalCloseButton.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    function showError(message) {
        showModal("ì˜¤ë¥˜ ë°œìƒ", message);
    }

    // ì´ˆê¸°í™”
    window.onload = initializeFirebase;
    switchTab('register'); // ì´ˆê¸° íƒ­ ì„¤ì •

</script>
</body>
</html>